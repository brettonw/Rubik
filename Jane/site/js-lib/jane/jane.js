"use strict";var EventSource=Object.create(null);EventSource.init=function(a){this.subscribers=[];if("name" in a){this["name"]=a.name}return this};EventSource.findSubscriberTargetIndex=function(b){for(var a=0,c=this.subscribers.length;a<c;++a){if(this.subscribers[a].subscriber===b){return a}}return -1};EventSource.addSubscriber=function(a){var b=null;if(this.findSubscriberTargetIndex(a)==-1){b={subscriber:a};this.subscribers.push(b);a.addSource(this)}return b};EventSource.removeSubscriber=function(b){var a=this.findSubscriberTargetIndex(b);if(a>=0){this.subscribers.splice(a,1);b.removeSource(this)}};EventSource.postEvent=function(c,e){for(var a=0,b=this.subscribers.length;a<b;++a){var d=this.subscribers[a];d.subscriber.receiveEvent(this,c,e)}};var EventSubscriber=Object.create(null);EventSubscriber.init=function(a){this.sources=[];this.isEventSubscriber=true;if("name" in a){this["name"]=a.name}return this};EventSubscriber.addSource=function(a){if(this.sources.indexOf(a)==-1){this.sources.push(a);a.addSubscriber(this)}};EventSubscriber.removeSource=function(b){var a=this.sources.indexOf(b);if(a>=0){this.sources.splice(a,1);b.removeSubscriber(this)}};EventSubscriber.removeAllSources=function(){while(this.sources.length>0){var a=this.sources[0];a.removeSubscriber(this)}};EventSubscriber.receiveEvent=function(b,a,c){};EventSubscriber.clearSubscribers=function(a){Object.getOwnPropertyNames(a).forEach(function(b){var c=a[b];if((c!=null)&&(typeof c==="object")&&("isEventSubscriber" in c)){c.removeAllSources()}})};var Jane=function(b){var a=Object.create(b).init({name:"Jane"});a.isJane="isJane";a.monitor=Object.create(EventSubscriber).init({name:"Jane.monitor"});a.monitor.receiveEvent=function(d,c,e){a.postEvent(c,null)};a.constants={PK:"PK"};a.events={DATA_REFERENCE_ADDED:"DATA_REFERENCE_ADDED",DATA_REFERENCE_SELECTED:"DATA_REFERENCE_SELECTED",DATA_REFERENCE_REMOVED:"DATA_REFERENCE_REMOVED",DATA_POPULATING:"DATA_POPULATING",DATA_POPULATED:"DATA_POPULATED",DATA_FLUSHED:"DATA_FLUSHED",DATA_CHANGED:"DATA_CHANGED",HIGHLIGHT_CHANGED:"HIGHLIGHT_CHANGED"};a.dataRefs={index:{},root:null,depth:0,addNode:function(d,c){var e=((c!=null)&&("source" in c)&&(c.source.name in this.index))?this.index[c.source.name]:this.root;var g=(e!=null)?e.depth+1:0;this.depth=Math.max(g,this.depth);var f={name:d,depth:g,children:[],parent:e,dataRef:c};this.index[d]=f;if(e!=null){e.children.push(f)}return f},removeNode:function(d){while(d.children.count>0){var e=d.children[0];this.removeNode(e)}if(d.parent!=null){var c=d.parent.children.indexOf(d);if(c>=0){d.parent.children.splice(c,1)}d.parent=null}delete this.index[d.name]}};a.dataRefs.root=a.dataRefs.addNode("Jane",null);a.addDataReference=function(c){if(!(c.name in this.dataRefs.index)){this.dataRefs.addNode(c.name,c);c.addSubscriberReadOnly(this.monitor);this.postEvent(a.events.DATA_REFERENCE_ADDED,c);return c}return null};a.removeDataReference=function(c){if(c.name in this.dataRefs.index){var d=this.dataRefs.index[c.name];d.dataRef.flush();a.dataRefs.removeNode(d);this.postEvent(a.events.DATA_REFERENCE_REMOVED,c)}};a.reset=function(){while(this.dataRefs.root.children.length>0){this.removeDataReference(this.dataRefs.root.children[0].dataRef);this.dataRefs.depth=0}};a.getDataReference=function(c){if(c in this.dataRefs.index){return this.dataRefs.index[c].dataRef}return null};a.onJane=function(){};a.EventSource=EventSource;a.EventSubscriber=EventSubscriber;window.top.Jane=a;return a}(EventSource);Jane.Utility=function(b){var a=Object.create(b);a.sortLexical=function(f,d,i,j){if(f==null){return(d!=null)?(j?-1:1):0}if(d==null){return(j?1:-1)}switch(i){case"number":case"integer":case"float":case"double":return j?(f-d):(d-f);break;case"string":var e=Number(f);var c=Number(d);if((e==f.toString())&&(c==d.toString())){return j?(e-c):(c-e)}f=f.replace(/\s*/g,"").toLowerCase();d=d.replace(/\s*/g,"").toLowerCase();return j?f.localeCompare(d):d.localeCompare(f);break;case"datetime":case"timestamp":case"temporal":var h=new Date(f).valueOf();var g=new Date(d).valueOf();return j?(h-g):(g-h);break}return 0};a.objectIsEmpty=function(c){return(Object.getOwnPropertyNames(c).length==0)};a.objectType=function(c){return({}).toString.call(c).match(/\s([a-zA-Z]+)/)[1].toLowerCase()};return a}(null);Jane.Schema=function(b){var a=Object.create(b);a.init=function(c){return this};return a}(null);Jane.Filter=function(b){var a=Object.create(b);return a}(null);Jane.Filter.Operator=function(b){var a=Object.create(b);a.init=function(c){if("column" in c){this["column"]=c.column}if("operator" in c){this["operator"]=c.operator}if("value" in c){this["value"]=c.value}return this};a.getRange=function(f,c){var e=f.getIndex(this.column);var d=e.queryOperator(this.operator,this.value,c);return d};return a}(null);Jane.Filter.In=function(b){var a=Object.create(b);a.init=function(c){if("column" in c){this["column"]=c.column}if("values" in c){this["values"]=c.values}return this};a.getRange=function(c,p){var m=c.getIndex(this.column);var d={};for(var k=0,l=values.length;k<l;++k){var o=values[k];var n=m.queryOperator("=",o,p);var g=Object.getOwnPropertyNames(n);for(var h=0,e=g.length;h<e;++h){var f=g[h];d[f]=f}}return d};return a}(null);Jane.Filter.And=function(b){var a=Object.create(b);a.init=function(c){if("filters" in c){this["filters"]=c.filters}return this};a.getRange=function(c,o){var e=o;if(this.filters.length>0){for(var k=0,n=this.filters.length;k<n;++k){var l=this.filters[k].getRange(c,e);var f={};var d=Object.getOwnPropertyNames(l);for(var h=0,g=d.length;h<g;++h){var m=d[h];if(m in e){f[m]=m}}e=f}}return e};return a}(null);Jane.Filter.Or=function(a){var b=Object.create(a);b.init=function(c){if("filters" in c){this["filters"]=c.filters}return this};b.getRange=function(c,m){var e=m;if(this.filters.length>0){e=this.filters[0].getRange(c,m);for(var h=1,l=this.filters.length;h<l;++h){var d=Object.getOwnPropertyNames(range);for(var g=0,f=d.length;g<f;++g){var k=d[g];e[k]=k}}}return e};return b}(null);Jane.MetaData=function(b){var a=Object.create(b);a.init=function(c){this.columns={};this.tags={};this.map={};return this};a.addColumn=function(e,g,d){this.columns[e]={name:e,type:g,tags:d};this.map[e.toLowerCase()]=e;for(var f=0,j=d.length;f<j;++f){var c=d[f];var h=Jane.Utility.objectType(c);if(h=="string"){if(!(c in this.tags)){this.tags[c]=[]}this.tags[c].push(e)}}};a.getMappedColumn=function(c){var d=c.toLowerCase();if(d in this.map){c=this.map[d];return this.columns[c]}return null};a.getColumnsByTag=function(c){if(c in this.tags){return this.tags[c]}return null};a.getPrimaryKey=function(){if(Jane.constants.PK in this.tags){var c=this.tags[Jane.constants.PK];if(c.length>0){return c[0]}}return null};return a}(null);Jane.Index=function(a){var b=Object.create(a);b.init=function(c){if("bag" in c){this["bag"]=c.bag}if("column" in c){this["column"]=c.column}this.index=this.buildIndex();return this};b.buildIndex=function(){var h=[];var d=this.column;var j=this.bag.metaData.columns;if(d in j){var c=this.bag.records;for(var e=0,g=c.length;e<g;++e){var f=c[e];h.push({value:f[d],index:e})}var k=j[d].type;var l=function(m,i){return Jane.Utility.sortLexical(m.value,i.value,k,true)};h.sort(l)}return h};b.queryList=function(c){};b.queryOperator=function(d,j,l){var k=this.bag.metaData.columns[this.column].type;var g=this.index;var f=g.length;var h=function(){var o=0;var n=f;while(o<n){var m=Math.floor((o+n)/2);if(Jane.Utility.sortLexical(g[m].value,j,k,true)<0){o=m+1}else{n=m}}return o}();var e=function(o){var n=f;while(o<n){var m=Math.floor((o+n)/2);if(Jane.Utility.sortLexical(g[m].value,j,k,true)==0){o=m+1}else{n=m}}return n}(h);var i=function(o,q,p){if(d in o){for(var n=q;n<p;++n){var m=g[n].index;if(m in l){c[m]=m}}}};var c={};i({"<":"<","<=":"<="},0,h);i({"<=":"<=","=":"=",">=":">="},h,e);i({">":">",">=":">="},e,f);return c};return b}(null);Jane.Bag=function(b){var a=Object.create(b);a.init=function(c){if("namespace" in c){this["namespace"]=c.namespace}if("metaData" in c){this["metaData"]=c.metaData}if("records" in c){this["records"]=c.records}if("writable" in c){this["writable"]=c.writable}this.index={};return this};a.getPrimaryKey=function(){return this.metaData.getPrimaryKey()};a.getIndex=function(d){var c=null;if(d in this.metaData.columns){if(!(d in this.index)){c=Object.create(Jane.Index).init({bag:this,column:d});this.index[d]=c}else{c=this.index[d]}}return c};a.compileSelect=function(m,c){if(m==null){return null}var k=c.getPrimaryKey();var l=[k];var g=Jane.Utility.objectType(m);var h=(g=="string")?m.split(/,([^,]*)/g):m;for(var e=0,f=h.length;e<f;++e){if(h[e].length>0){var d=h[e].replace(/^\s*\[?\s*(.*)/,"$1");d=d.replace(/((\s*[^\s\]]+)+)\s*\]?\s*$/,"$1");var j=c.getMappedColumn(d);if(j!=null){if(j.name!=k){l.push(j.name)}else{}}else{}}}return(l.length>0)?l:null};a.selectMetaData=function(j,d){if(j!=null){var h=Object.create(Jane.MetaData).init();for(var f=0,g=j.length;f<g;++f){var e=j[f];var c=d.columns[e];h.addColumn(e,c.type,c.tags)}d=h}return d};a.compileWhere=function(c,e){var d=Jane.Utility.objectType(c);return(d=="string")?null:c};a.compileSort=function(k,d){if(k==null){return null}var f=Jane.Utility.objectType(k);var l=(f=="string")?k.split(/,([^,]*)/g):k;var c=[];for(var g=0,h=l.length;g<h;++g){if(l[g].length>0){var e=l[g];var m="asc";var j=e.search(/(asc|desc)\s*$/i);if(j>0){m=e.substring(j).toLowerCase().replace(/(\S*)\s+$/,"$1");e=e.substring(0,j)}e=e.replace(/^\s*\[?\s*(.*)/,"$1");e=e.replace(/((\s*[^\s\]]+)+)\s*\]?\s*$/,"$1");var n=d.getMappedColumn(e);if(n!=null){c.push({name:n.name,asc:(m=="asc")})}else{}}}return(c.length>0)?c:null};a.query=function(r,n,o,z,f){var p=this.namespace;var v=this.metaData;var s=this.compileSelect(r,v);v=this.selectMetaData(s,v);var t=this.compileWhere(n,v);var g=this.compileSort(z,v);var x=this.records;var q={};for(var w=0,k=x.length;w<k;++w){q[w]=w}if(t!=null){q=t.getRange(this,q)}var y=[];var m=Object.getOwnPropertyNames(q);m.sort();for(var w=0,k=m.length;w<k;++w){var l=m[w];var c=x[l];if(s!=null){var e={};for(var u=0,h=s.length;u<h;++u){var d=s[u];e[d]=c[d]}c=e}else{if(f){c=Object.create(c)}}if(o!=null){c=o.handleRecord(c,f)}y.push(c)}if(g!=null){y.sort(function(A,j){for(var D=0,E=g.length;D<E;++D){var B=g[D];var C=Jane.Utility.sortLexical(A[B.name],j[B.name],v.columns[B.name].type,B.asc);if(C!=0){return C}}return 0})}return Object.create(a).init({namespace:p,metaData:v,records:y,writable:f})};a.buildIndex=function(d){var c=Object.create(Jane.Index).init({bag:this,column:d});this.index[d]=c;return c};return a}(null);Jane.Transform=function(b){var a=Object.create(b);return a}(null);Jane.Transform.Assemble=function(b){var a=Object.create(b,{name:{value:"Assemble",enumerable:true,writable:false}});a.init=function(c){if("displayName" in c){this["displayName"]=c.displayName}if("values" in c){this["values"]=c.values}return this};a.handleRecord=function(c,g){var e={};var d=this.values;for(var f=0,h=d.length;f<h;++f){e[d[f].displayName]=c[d[f].sourceColumn]}if(g){c=Object.create(c)}c[this.displayName]=e;return c};return a}(null);Jane.Transform.Extract=function(b){var a=Object.create(b,{name:{value:"Extract",enumerable:true,writable:false},extract:{value:"xxx",enumerable:true,writable:true}});a.init=function(c){if("extract" in c){this["extract"]=c.extract}return this};a.handleRecord=function(c,d){if(this.extract in c){return d?Object.create(c[this.extract]):c[this.extract]}else{}return c};return a}(null);Jane.Transform.Flatten=function(a){var b=Object.create(a,{name:{value:"Flatten",enumerable:true,writable:false}});b.init=function(c){return this};b.enumerateRecord=function(c,d){for(var e in c){if(c.hasOwnProperty(e)){var f=c[e];var g=typeof(f);if(g=="object"){this.EnumerateRecord(f,d)}else{d[e]=f}}}};b.handleRecord=function(c,e){var d=Object.create(null);this.enumerateRecord(c,d);return d};return b}(null);Jane.Transform.Compound=function(b){var a=Object.create(b,{name:{value:"Compound",enumerable:true,writable:false}});a.init=function(c){if("transforms" in c){this["transforms"]=c.transforms}return this};a.handleRecord=function(c,e){for(var d=0,f=this.transforms.length;d<f;++d){c=this.transforms[d].handleRecord(c,e);e=false}return c};return a}(null);Jane.DataObject=function(b){var a=Object.create(b,{allowFlushForSubscription:{value:false,enumerable:true,writable:true}});a.init=function(c){b.init.call(this,c);this["select"]=("select" in c)?c.select:null;this["where"]=("where" in c)?c.where:null;this["transform"]=("transform" in c)?c.transform:null;this["sort"]=("sort" in c)?c.sort:null;if("allowFlushForSubscription" in c){this["allowFlushForSubscription"]=c.allowFlushForSubscription}return Jane.addDataReference(this)};a.canAddSubscriber=function(g){if(!Jane.Utility.objectIsEmpty(g)){for(var c in g){if(g.hasOwnProperty(c)){for(var d=0,f=this.subscribers.length;d<f;++d){var e=this.subscribers[d];if(c in e.contract){return false}}}}if(this.hasBag()&&this.bag.writable){if(this.allowFlushForSubscription){this.flush()}else{return false}}}return true};a.addSubscriberWithContract=function(e,d){if(this.canAddSubscriber(d)){var c=b.addSubscriber.call(this,e);if(c!=null){c.contract=d}return c}return null};a.addSubscriberReadOnly=function(c){return this.addSubscriberWithContract(c,{})};a.addSubscriber=function(c){return null};a.hasBag=function(){return("bag" in this)};a.getBag=function(){return this.hasBag()?this.bag:null};a.getBagIsWritable=function(){if(this.hasBag()){return this.bag.writable}for(var c=0,e=this.subscribers.length;c<e;++c){var d=this.subscribers[c];if(!Jane.Utility.objectIsEmpty(d.contract)){return true}}return false};a.populateResponse=function(e,d){if(e!=null){var c=this.getBagIsWritable();if((this.sort!=null)||(this.select!=null)||(this.where!=null)||(this.transform!=null)||(c)){e=e.query(this.select,this.where,this.transform,this.sort,c)}this.bag=e;delete this.populateRequested;this.postEvent(d,null)}};a.populateExec=function(){this.populateRequested=true;this.postEvent(Jane.events.DATA_POPULATING,null)};a.populate=function(){if(!this.hasBag()){this.populateExec()}};a.post=function(){if(this.hasBag()){this.postEvent(Jane.events.DATA_POPULATED,null)}else{this.populateExec()}};a.flush=function(){if(this.hasBag()){delete this.bag;this.postEvent(Jane.events.DATA_FLUSHED,null)}};a.refresh=function(){this.flush();this.populateExec()};return a}(EventSource);Jane.DataObjectReference=function(b){var a=Object.create(b);a.init=function(e){if("source" in e){this["source"]=e.source}var d=b.init.call(this,e);if(d!==null){this.monitor=Object.create(EventSubscriber).init({name:(this.name+".monitor")});var c=this;this.monitor.receiveEvent=function(g,f,h){c.handleSourceEvent(g,f,h)};this.source.addSubscriberReadOnly(this.monitor)}return d};a.handleSourceEvent=function(d,c,e){switch(c){case Jane.events.DATA_POPULATED:if("populateRequested" in this){this.populateResponse(d.getBag(),c)}break;case Jane.events.DATA_CHANGED:if(this.hasBag()){this.populateResponse(d.gatBag(),c)}break;case Jane.events.DATA_FLUSHED:this.flush();break;default:break}};a.populateExec=function(){b.populateExec.call(this);var c=this.source.getBag();if(c!=null){this.populateResponse(c,Jane.events.DATA_POPULATED)}else{this.source.populate()}};return a}(Jane.DataObject);Jane.DataObjectEspace=function(b){var a=Object.create(b);a.init=function(c){if("resultSetUrl" in c){this["dataUrl"]=c.resultSetUrl}if("cdmMapUrl" in c){this["metaDataUrl"]=c.cdmMapUrl}if("resultSetId" in c){this["resultSetId"]=c.resultSetId}if("numRows" in c){this["recordCount"]=c.numRows}c.name=c.dataSourceName+" ("+c.resultSetName+")";return b.init.call(this,c)};a.populateExec=function(){b.populateExec.call(this);var c=this;$.getJSON(this.dataUrl,function(l){var f=Object.create(Jane.MetaData).init({});var q=l.table.metaData.rowSetMetadata;var j=q.columnMetadata;Object.getOwnPropertyNames(j).forEach(function(i){var u=j[i];var t=(u.types.length>0)?u.types[0]:"string";f.addColumn(u.displayName,t,u.tags)});var h=[];var k=q.geoPointColumns;for(var m=0,o=k.length;m<o;++m){var s=k[m];var g=j[s.longitudeColumn].displayName;var n=j[s.latitudeColumn].displayName;var r={typeName:"GeoPoint",displayName:s.displayName,values:[{displayName:"longitude",sourceColumn:g},{displayName:"latitude",sourceColumn:n}]};h.push(r)}var p=[Object.create(Jane.Transform.Extract).init({extract:"data"})];for(var m=0,o=h.length;m<o;++m){var r=h[m];f.addColumn(r.displayName,r.typeName,[]);var e=Object.create(Jane.Transform.Assemble).init(r);p.push(e)}c.transform=Object.create(Jane.Transform.Compound).init({transforms:p});var d=Object.create(Jane.Bag).init({namespace:"espace",metaData:f,records:l.table.rows,writable:false});c.populateResponse(d,Jane.events.DATA_POPULATED)})};return a}(Jane.DataObject);