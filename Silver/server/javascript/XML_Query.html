<!-- #include file="SQL_Database.html" -->
<!-- #include file="XML_Format.html" -->
<!-- #include virtual="/server/sql.html" -->

<script language="javascript" runat="server">
	//--------------------------------------------------------------------------
	// return a record in an XML formatted string
	//--------------------------------------------------------------------------
	function XML_Format_Record (priv_record_set)
	{
		var	xml = new String;

		// only proceed if the record is valid
		if (! priv_record_set.EOF)
		{
			// count the fields in the record
			var	count = priv_record_set.Fields.Count;

			// iterate over all of the fields, formatting each one in turn
			var i;
			for (i = 0; i < count; i++)
			{
				var	name = new String (priv_record_set.Fields (i).name);
				var	value =  escape (priv_record_set.Fields (i));
				xml += XML_Format (name, value);
			}
		}

		// return the formatted response
		return xml;
	}
	
	//--------------------------------------------------------------------------
	// return query results in an XML formatted string
	//--------------------------------------------------------------------------
	function XML_Format_Query (tag, record_set)
	{
		var	xml = new String;

		// iterate over all of the records, formatting each one in turn
		while (! record_set.EOF)
		{
			xml += XML_Format (tag, XML_Format_Record (record_set));
			record_set.MoveNext ();
		}

		// return the formatted response
		return xml;
	}
	
	//--------------------------------------------------------------------------
	// open the connection and perform the query
	//--------------------------------------------------------------------------
	function XML_Query (database, query, base_tag, tag)
	{
		// perform the query
		var	record_set = database.Query (query);

		// format the results, and print it
		var	xml = XML_Format (base_tag, XML_Format_Query (tag, record_set));

		// release the query
		record_set.Close ();

		// return the formatted response
		return xml;
	}

	//--------------------------------------------------------------------------
	// open the connection and perform the query
	//--------------------------------------------------------------------------
	function XML_Connect_And_Query (catalog, query)
	{
		// open the database
		var	database = new SQL_Database (sql_server, sql_username, sql_password, catalog);

		// perform the query and print the result
		var	xml = XML_Query (database, query, "RecordSet", "Record");

		// close the database connection
		database.Close ();

		// return the formatted response
		return xml;
	}

	//--------------------------------------------------------------------------
</script>
